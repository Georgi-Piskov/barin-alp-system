# БАРИН АЛП - Строително-финансова система

## Обща информация за проекта

**Тип проект:** PWA (Progressive Web App) за управление на финанси и инвентар в строителна фирма

**Технологичен стек:**
- Frontend: PWA (HTML, CSS, JavaScript) - хостван на GitHub Pages
- Backend: n8n (workflow automation)
- База данни: Google Sheets (разделени таблици за сигурност)
- Файлово хранилище: Google Drive (за снимки на инструменти)
- Известия: Telegram ботове (интегрирани чрез n8n)

**Потребители:**
- 3 Техници (технически ръководители)
- 2 Директори (собственици/партньори)

---

## МОДУЛ 1: Финансово управление

### 1.1 Цел на модула

Проследяване на финансовите ресурси на фирмата:
- Заприходяване на пари към техници (кеш или банков превод)
- Отчитане на разходи по обекти
- Въвеждане на фактури с детайлни позиции
- Разпределяне на разходи от една фактура към различни обекти
- Следене на банкови транзакции чрез качване на PDF извлечения от Asset Bank
- Идентифициране на неплатени фактури и плащания без фактура

### 1.2 Профил на техник

**Функционалности:**
1. **Dashboard** - Показва САМО личния баланс на техника (НЕ баланса на фирмата)
   - Баланс = Заприходено - Похарчено
   - Пример: Заприходени 1000 лв, похарчени 235 лв → Баланс: 765 лв

2. **Нов разход / Фактура** - Бързо въвеждане (цел: под 30 секунди)
   - Форма, която прилича на стандартна фактура за интуитивност
   - Полета: Доставчик, Номер на фактура, Дата, Обща стойност
   - Възможност за добавяне на позиции (материали):
     - Име на материал/услуга
     - Количество
     - Единична цена
     - Стойност

3. **Разпределение по обекти** (след запазване на фактура)
   - **По подразбиране (90% от случаите):** Цялата фактура отива в един обект
   - **Опция "Раздели фактура":** Drag & drop на отделни позиции към различни обекти
   - **Отметка "Раздели количество":** За редки случаи когато един материал се разделя
     - Пример: 20 торби цимент → 8 за Обект А, 12 за Обект Б

4. **Моите фактури** - Списък с въведени фактури с филтри

5. **Инвентар** - Достъп до модула за инструменти

### 1.3 Профил на директор

**Функционалности (пълен достъп):**

1. **Dashboard**
   - Общо финансово състояние на фирмата
   - Разходи по обекти (графики)
   - Баланси на всички техници
   - Предупреждения за неплатени фактури

2. **Заприходяване на техници**
   - Форма: Избор на техник, сума, метод (кеш/превод), дата
   - Автоматично увеличава баланса на техника

3. **Банкови извлечения**
   - Upload на PDF от Asset Bank
   - Автоматично парсване на транзакции
   - Преглед и потвърждение преди записване
   - Съпоставяне с фактури (по сума и дата ±3 дни)

4. **Финансов анализ**
   - Неплатени фактури (има фактура, няма банково плащане)
   - Плащания без фактура (има банкова транзакция, няма фактура)
   - Формула: Реална наличност = Банков баланс - Неплатени фактури

5. **Управление на обекти**
   - Създаване на нов обект (кратко име + пълно име)
   - Затваряне на обект (архивиране)
   - Преглед на разходи по обект (drill-down до позиции)

6. **Всички разходи** - Филтриране по техник, обект, период, доставчик

7. **Въвеждане на директорски разходи**
   - Директорите също могат да въвеждат разходи
   - С или без фактура (за кеш плащания)

### 1.4 Текущи обекти (примери)

| Кратко име | Пълно име |
|------------|-----------|
| НТ2 | АВАРИЙНИ РЕМОНТНО-ВЪЗСТАНОВИТЕЛНИ ДЕЙНОСТИ ПО САМОСРУТИЛИ СЕ ПОДПОРНИ СТЕНИ И ИЗТОЧЕН КРЕПОСТЕН ЗИД, ЧАСТ ОТ АРХЕОЛОГИЧЕСКИ КОМПЛЕКС "НЕБЕТ ТЕПЕ" - ЕТАП 2 |
| МОМ | Еднофамилна жилищна сграда в УПИ IV-26 (ПИ 49014.501.26) кв.24 по плана на с.Момчиловци, община Смолян |

---

## МОДУЛ 2: Инвентар

### 2.1 Цел на модула

Проследяване на инструменти и оборудване:
- База данни с всички инструменти
- Знание кой инструмент при кого е
- Снимки при вземане и връщане (за отчетност на състоянието)
- Система за заявки и прехвърляне между техници

### 2.2 Функционалности

1. **Списък инструменти**
   - Търсене по име
   - Филтър: При кого е, Наличен в склад
   - Показва: Име, Снимка, Текущ притежател

2. **Детайли на инструмент**
   - Снимка (последна)
   - История на движението (кой, кога, снимка)
   - Последните 5 снимки (старите се трият автоматично)

3. **Вземане от склад**
   - Задължителна снимка при вземане
   - Автоматична смяна на "При кого" в базата

4. **Връщане в склад**
   - Задължителна снимка при връщане
   - Сравнение със снимката при вземане
   - Ако е върнат в лошо състояние → отчетност

5. **Заявка за инструмент**
   - Техник А иска инструмент от Техник Б
   - Известие до Техник Б
   - Потвърждение → Физическо предаване → Снимка → Смяна в базата

### 2.3 Снимки

- **Компресия:** До 500KB преди upload (client-side)
- **Съхранение:** Google Drive папка `/Инвентар/{tool_id}/`
- **Автоматично почистване:** Пазят се последните 5 снимки на инструмент

---

## АРХИТЕКТУРА НА ДАННИТЕ

### Google Sheets структура

**ВАЖНО:** Разделени таблици за сигурност. Сензитивната информация е достъпна само за директори.

#### Таблица: `Техник_[Име]` (отделна за всеки техник)
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Дата | date | Дата на транзакция |
| Тип | enum | "заприходяване" / "разход" |
| Сума | number | Стойност в лева |
| Метод | enum | "кеш" / "превод" |
| Обект_ID | string | Референция към обект (за разходи) |
| Фактура_ID | string | Референция към фактура (ако има) |
| Описание | string | Забележка |
| Баланс | number | Изчислен баланс след транзакцията |

**Достъп:** Съответният техник + Директори

#### Таблица: `Фактури`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Техник_ID | string | Кой е въвел фактурата |
| Доставчик | string | Име на фирма доставчик |
| Номер | string | Номер на фактура |
| Дата | date | Дата на фактура |
| Обща_стойност | number | Обща стойност |
| Статус | enum | "платена" / "неплатена" |
| Създадена_на | datetime | Timestamp |

**Достъп:** Всички

#### Таблица: `Позиции_Разходи`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Фактура_ID | string | Референция към фактура |
| Обект_ID | string | Към кой обект е разходът |
| Материал | string | Име на материал/услуга |
| Количество | number | Брой/единици |
| Единица | string | бр, кг, м, л, и т.н. |
| Ед_цена | number | Единична цена |
| Стойност | number | Количество × Ед_цена |

**Достъп:** Всички

#### Таблица: `Банкови_Транзакции`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Дата | date | Дата на транзакция |
| Референция | string | Банкова референция |
| Описание | string | Описание от банката |
| Тип | enum | "дебит" / "кредит" |
| Сума | number | Стойност |
| Салдо | number | Салдо след транзакция |
| Фактура_ID | string | Съпоставена фактура (ако има) |
| Статус | enum | "съпоставена" / "несъпоставена" |

**Достъп:** Само директори

#### Таблица: `Master_Finance`
- IMPORTRANGE от всички таблици на техници
- Банкови транзакции
- Агрегирани данни за dashboard

**Достъп:** Само директори

#### Таблица: `Обекти`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Кратко име (НТ2, МОМ) |
| Пълно_име | string | Пълно описание |
| Статус | enum | "активен" / "затворен" |
| Дата_откриване | date | Кога е създаден |
| Дата_затваряне | date | Кога е затворен (ако е) |

**Достъп:** Всички

#### Таблица: `Инвентар`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Име | string | Име на инструмент |
| Описание | string | Допълнително описание |
| При_кого | string | Техник_ID или "склад" |
| Последна_снимка | string | URL към Google Drive |
| Дата_последна_смяна | datetime | Кога последно е сменен притежател |

**Достъп:** Всички

#### Таблица: `Инвентар_История`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Инструмент_ID | string | Референция към инструмент |
| От_кого | string | Предишен притежател |
| Към_кого | string | Нов притежател |
| Дата | datetime | Кога е станало |
| Снимка_URL | string | Снимка при предаване |
| Забележка | string | Коментар |

**Достъп:** Всички

#### Таблица: `Потребители`
| Колона | Тип | Описание |
|--------|-----|----------|
| ID | string | Уникален идентификатор |
| Име | string | Пълно име |
| Роля | enum | "техник" / "директор" |
| Email | string | За идентификация |
| Telegram_ID | string | За известия |

**Достъп:** Само директори (за управление)

---

## N8N WORKFLOWS

### 1. Asset Bank PDF Parser

**Trigger:** Webhook (POST с PDF файл)

**Стъпки:**
1. Получаване на PDF файл
2. Extract From File (извличане на текст)
3. Code Node - Regex парсване:
   - Формат: `DD.MM.YYYY | Референция | Описание | BGN | Сума | Салдо`
   - Пример: `17.12.2025 | 5920528 | ПЛАЩАНЕ ПО ФАКТУРА | BGN | 396.39 | 12500.00`
4. Записване в `Банкови_Транзакции`
5. Автоматично съпоставяне с фактури (по сума ±0.01 и дата ±3 дни)
6. Връщане на резултат към PWA

**Asset Bank формат:**
```
Дата: DD.MM.YYYY
Референция: 7-цифрен номер
Описание: Текст на кирилица/латиница
Валута: BGN
Дебит/Кредит: Число с 2 десетични
Салдо: Число с 2 десетични
```

### 2. CRUD Операции

**Endpoints (Webhooks):**
- `POST /api/transactions` - Нова транзакция
- `POST /api/invoices` - Нова фактура с позиции
- `POST /api/allocate` - Разпределяне на позиции по обекти
- `GET /api/balance/{technicianId}` - Баланс на техник
- `GET /api/objects` - Списък обекти
- `POST /api/objects` - Нов обект
- `GET /api/inventory` - Списък инструменти
- `POST /api/inventory/transfer` - Прехвърляне на инструмент

### 3. Inventory Image Management

**Trigger:** Webhook (POST с изображение)

**Стъпки:**
1. Получаване на base64 изображение
2. Upload в Google Drive `/Инвентар/{tool_id}/`
3. Получаване на shareable link
4. Обновяване на `Инвентар` таблица
5. Записване в `Инвентар_История`

**Scheduled Cleanup (Daily):**
1. За всеки инструмент - вземи снимки от папката
2. Сортирай по дата
3. Изтрий всички освен последните 5

### 4. Telegram Notifications (по преценка)

**Triggers:**
- Нова заявка за инструмент → Известие до притежателя
- Ниска наличност на техник → Известие до директори
- Неплатена фактура > 7 дни → Известие до директори

---

## UX ДИЗАЙН ПРИНЦИПИ

### Приоритет: Скорост и интуитивност

1. **Mobile-first** - Техниците са на обекти с телефони
2. **Минимум кликове** - Най-честите действия с 1-2 tap-а
3. **Smart defaults** - Предварително попълнени полета (днешна дата, последен обект)
4. **Autocomplete** - За доставчици, материали (кеширани последни 20)
5. **Визуална обратна връзка** - Ясни индикатори за успех/грешка

### Ключови екрани

#### Техник - Нов разход
```
┌─────────────────────────────────────┐
│  ← Нов разход                       │
├─────────────────────────────────────┤
│  Доставчик: [________________] ▼    │
│  № Фактура: [________________]      │
│  Дата:      [17.12.2025] 📅         │
│  Обща стойност: [________] лв       │
├─────────────────────────────────────┤
│  ПОЗИЦИИ                            │
│  ┌─────────────────────────────┐    │
│  │ Цимент 25кг    10 × 8.50 = 85│    │
│  │ Пясък          2 × 45.00 = 90│    │
│  └─────────────────────────────┘    │
│  [+ Добави позиция]                 │
├─────────────────────────────────────┤
│  [Запази и разпредели →]            │
└─────────────────────────────────────┘
```

#### Разпределение по обекти
```
┌─────────────────────────────────────┐
│  ← Разпредели по обекти             │
├─────────────────────────────────────┤
│  Фактура #1234 | 175.00 лв          │
├─────────────────────────────────────┤
│  ○ Цяла фактура в един обект        │
│    [Избери обект ▼]                 │
│                                     │
│  ○ Раздели по позиции               │
├─────────────────────────────────────┤
│  При избор "Раздели":               │
│  ┌─────────────────────────────┐    │
│  │ Цимент 25кг (85лв) → [НТ2▼] │    │
│  │ ☐ Раздели количество        │    │
│  │ Пясък (90лв)       → [МОМ▼] │    │
│  └─────────────────────────────┘    │
├─────────────────────────────────────┤
│  [Готово ✓]                         │
└─────────────────────────────────────┘
```

#### Директор - Dashboard
```
┌─────────────────────────────────────┐
│  БАРИН АЛП                    👤    │
├─────────────────────────────────────┤
│  Банков баланс:     45,230.00 лв    │
│  Неплатени фактури: -8,500.00 лв    │
│  ─────────────────────────────      │
│  Реална наличност:  36,730.00 лв    │
├─────────────────────────────────────┤
│  БАЛАНСИ НА ТЕХНИЦИ                 │
│  Иван:    1,250.00 лв               │
│  Петър:     780.00 лв               │
│  Георги:  2,100.00 лв               │
├─────────────────────────────────────┤
│  РАЗХОДИ ПО ОБЕКТИ (този месец)     │
│  НТ2: ████████████ 12,500 лв        │
│  МОМ: ████████     8,200 лв         │
├─────────────────────────────────────┤
│  ⚠️ 3 неплатени фактури             │
│  ⚠️ 2 плащания без фактура          │
└─────────────────────────────────────┘
```

---

## ОФЛАЙН СТРАТЕГИЯ

**Приоритет:** Нисък (рядко без интернет)

**Базови мерки:**
- Service Worker за кеширане на статични ресурси
- PWA manifest за install на телефон
- Локално кеширане на списък обекти и доставчици

**НЕ се имплементира (засега):**
- Пълна офлайн функционалност
- Опашка за синхронизация
- Conflict resolution

---

## СИГУРНОСТ

### Принципи

1. **Разделени таблици** - Техник вижда само своите данни
2. **n8n като прокси** - Никакви credentials в PWA кода
3. **Google Sheets permissions** - Protected ranges за сензитивни данни
4. **HTTPS only** - GitHub Pages default

### Автентикация (препоръчителна имплементация)

- Прост PIN/парола на ниво приложение
- n8n валидира преди всяка операция
- Опционално: Google OAuth за по-сигурно решение

---

## ФАЙЛОВА СТРУКТУРА НА ПРОЕКТА

```
/barin-alp-pwa/
├── index.html              # Основна страница
├── manifest.json           # PWA manifest
├── sw.js                   # Service Worker
├── css/
│   ├── styles.css          # Основни стилове
│   └── mobile.css          # Mobile-specific
├── js/
│   ├── app.js              # Основна логика
│   ├── api.js              # Комуникация с n8n
│   ├── auth.js             # Автентикация
│   ├── invoice.js          # Логика за фактури
│   ├── inventory.js        # Логика за инвентар
│   └── camera.js           # Камера интеграция
├── pages/
│   ├── dashboard.html      # Dashboard
│   ├── new-expense.html    # Нов разход
│   ├── invoices.html       # Списък фактури
│   ├── inventory.html      # Инвентар
│   └── admin/              # Директорски страници
│       ├── overview.html
│       ├── technicians.html
│       └── bank-upload.html
└── assets/
    └── icons/              # PWA икони
```

---

## СТЪПКИ ЗА ИМПЛЕМЕНТАЦИЯ

### Фаза 1: Основа
1. [ ] Създаване на Google Sheets структура
2. [ ] PWA skeleton с routing
3. [ ] n8n базови webhooks (CRUD)
4. [ ] Автентикация (прост механизъм)

### Фаза 2: Финанси - Техник
5. [ ] Dashboard техник
6. [ ] Форма за нов разход/фактура
7. [ ] Разпределение по обекти
8. [ ] Списък фактури

### Фаза 3: Финанси - Директор
9. [ ] Dashboard директор
10. [ ] Заприходяване на техници
11. [ ] Asset Bank PDF upload и парсване
12. [ ] Съпоставяне фактури-плащания
13. [ ] Управление на обекти

### Фаза 4: Инвентар
14. [ ] Списък инструменти
15. [ ] Камера интеграция
16. [ ] Google Drive upload
17. [ ] Заявки и прехвърляне

### Фаза 5: Polish
18. [ ] Telegram известия
19. [ ] Отчети и експорт
20. [ ] Тестване и bugfixes

---

## БЕЛЕЖКИ ЗА РАЗРАБОТКА

1. **Винаги чети този файл** преди да правиш промени по проекта
2. **UX е приоритет** - Техниците трябва да могат да въвеждат разход за под 30 секунди
3. **Mobile-first** - Тествай на телефон често
4. **Google Sheets лимити** - 300 заявки/мин на проект, избягвай излишни четения
5. **Asset Bank PDF** - Форматът е фиксиран, regex е достатъчен за парсване
6. **Снимки** - Винаги компресирай до 500KB преди upload

---

*Последна актуализация: 17.12.2025*
